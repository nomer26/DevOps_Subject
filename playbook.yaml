- name: Ping & Install necessary S/W
  hosts: localhost
  tasks:
  - name: ping
    ansible.builtin.ping:

  - name: What is OS?
    command: uname -s
    register: OS
  - name: Install Helm
    ansible.builtin.get_url:
      url: "https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3"
      dest: ./get_helm.sh
      mode: "0700"
  - command: ./get_helm.sh

  - name: Install AWS CLI
    ansible.builtin.package:
      name: awscli
      state: present

  - name: install eksctl
    ansible.builtin.get_url:
      url: "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_{{ OS.stdout }}_amd64.tar.gz"
      dest: /tmp/eksctl

  - unarchive:
      src: /tmp/eksctl
      dest: /usr/local/bin
  - name: Ansible-galaxy Collection install  ( AWS & K8S )
    command: ansible-galaxy collection install kubernetes.core

  - command: ansible-galaxy collection install community.aws

- name: Create IAM OIDC Provider
  hosts: localhost
  tasks:
  - command: aws configure get region
    register: REGION
  - shell: aws sts get-caller-identity --query='Account' | sed 's/"//g'
    register: AWS_ACCOUNT_ID
  - shell: aws eks describe-cluster --name github-actions --query 'cluster.name' | sed 's/"//g'
    register: CLUSTER_NAME

  - command: "eksctl utils associate-iam-oidc-provider
    --region {{ REGION.stdout }}
    --cluster {{ CLUSTER_NAME.stdout }}
    --approve"

  - name: Download  AWS LB Controller IAM Policy
    ansible.builtin.get_url:
      url: "https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.5/docs/install/iam_policy.json"
      dest: ./iam_policy.json

  - name: Create IAM Role for AWSLoadBalancerControllerIAMPolicy (Unexpected failure during module execution)
    command: "aws iam create-policy
  --policy-name AWSLoadBalancerControllerIAMPolicy
  --policy-document file://iam_policy.json"
    ignore_errors: yes
    #community.aws.iam_managed_policy:
    #  policy_name: "AWSLoadBalancerControllerIAMPolicy"
    #  policy: "{{ lookup('file', 'iam_policy.json') }}"
    #  state: present

  - name: Create IAM Role & Service Account for AWS LB Controller
    command: "eksctl create iamserviceaccount
  --cluster {{ CLUSTER_NAME.stdout }}
--namespace kube-system
--name aws-load-balancer-controller
--attach-policy-arn arn:aws:iam::{{ AWS_ACCOUNT_ID.stdout }}:policy/AWSLoadBalancerControllerIAMPolicy
--override-existing-serviceaccounts
--region {{ REGION.stdout }}
--approve"

  - name: Update Kubeconfig
    command: "aws eks update-kubeconfig --region {{ REGION.stdout }} --name {{ CLUSTER_NAME.stdout }}"

  - name: Deploy AWS LB Controller Component
    kubernetes.core.helm:
      name: aws-load-balancer-controller
      chart_ref: eks/aws-load-balanacer-controller
      namespace: kube-system
      values:
        clusterName: "{{ CLUSTER_NAME.stdout }}"
        serviceAccount:
          create: false
          name: aws-load-balancer-controller
